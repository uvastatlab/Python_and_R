# Combine, Reshape and Merge

```{r,echo=FALSE}
knitr::opts_chunk$set(comment = NA, prompt = TRUE, collapse = TRUE)
```

This chapter looks at various strategies for combining, reshaping, and merging data.

## Combine rows

Combining rows may be thought of as "stacking" rectangular data structures.

#### Python {-}


#### R {-}

The `rbind()` function "binds" rows. It takes two or more objects. To row bind data frames the column names must match, otherwise an error is returned. If  columns being stacked have differing variable types, the values will be coerced according to `logical` < `integer` < `double` < `complex` < `character`. (E.g., if you stack a set of rows with type `logical` in column _J_ on a set of rows with type `character` in column _J_, the output will have column _J_ as type `character`.)

```{r}
d1 <- data.frame(x = 4:6, y = letters[1:3])
d2 <- data.frame(x = 3:1, y = letters[4:6])
rbind(d1, d2)
```

See also the `bind_rows()` function in the **dplyr** package.

## Combine columns

Combining columns may be thought of as setting rectangular data structures next to each other.

#### Python {-}


#### R {-}

The `cbind()` function "binds" columns. It takes two or more objects. To column bind data frames, the number of rows must match; otherwise, the object with fewer rows will have rows "recycled" (if possible) or an error will be returned.

```{r}
d1 <- data.frame(x = 10:13, y = letters[1:4])
d2 <- data.frame(x = c(23,34,45,44))
cbind(d1, d2)
```

```{r}
# example of recycled rows (d1 is repeated twice)
d1 <- data.frame(x = 10:13, y = letters[1:4])
d2 <- data.frame(x = c(23,34,45,44,99,99,99,99))
cbind(d1, d2)
```

See also the `bind_cols()` function in the **dplyr** package.

## Reshape wide to long

The next two sections discuss how to reshape data from wide to long and from long to wide. "Wide" data are data structured such that multiple values associated with a given unit (e.g., a person, a cell culture, etc.) are placed in the same row:
  
```{r, echo = F}
temp <- data.frame(name = c('larry', 'moe', 'curly'),
                   time_1_score = c(3, 6, 2),
                   time_2_score = c(0, 3, 1),
                   time_3_score = c(6, 3, 1))
temp
```

_Long_ data, conversely, are data structured such that all values are contained in one column, with another column identifying what value is given in any particular row (e.g., "time 1," "time 2," etc.):

```{r, echo = F}
temp <- data.frame(id = rep(c('larry', 'moe', 'curly'), each = 3),
                   time = rep(1:3, times = 3),
                   score = c(3, 0, 6, 6, 3, 3, 2, 1, 1))
temp
```

Shifting between these two data formats is often useful---necessarily, really---for implementing statistical techniques or representing data with particular visualizations.

#### Python {-}

#### R {-}

In base R, the `reshape()` function can take data from wide to long or long to wide. The **tidyverse** also provides functions for doing so: `pivot_longer()` and `pivot_wider()`. The **tidyverse** functions have a degree of intuitiveness and usability that may make them the go-to reshaping tools for many R users. We give examples below using base R and **tidyverse**.

For example, say we begin with a wide data frame, `df_wide`, that looks like this:
```{r, echo = F}
set.seed(10)
df_wide <- data.frame(id = rep(1:3),
                      sex = sample(c('m', 'f'), 3, replace = T),
                      wk1 = sample(1:20, 3, replace = T),
                      wk2 = sample(1:20, 3, replace = T),
                      wk3 = sample(1:20, 3, replace = T))
df_wide
```

To convert a data frame from wide to long using `reshape()`, the user must specify the argument `direction = 'long'`. The user also declares an `idvar` argument, which specifies variable(s) that uniquely identify each row and will therefore be repeated in long output (`id` and `sex`); a `varying` argument, which specifies the repeated measurements that are to be lengthened (`wk1`, `wk2`, and `wk3`); as well as `v.names` and `timevar` arguments, which respectively indicate the desired names of (1) the column containing the values in the long data (`weekly_val`) and (2) the column that identifies each value in the long data (`week`).

```{r}
df_long <- reshape(df_wide,
                        direction = 'long',
                        idvar = c('id', 'sex'),
                        varying = c('wk1', 'wk2', 'wk3'),
                        v.names = 'weekly_val',
                        timevar = 'week')
df_long
```

The **tidyverse** function for taking data from wide to long is `pivot_longer()`. To recreate the output of the `reshape()` function above using `pivot_longer()`, a user would write:
  
```{r, message = F}
library(tidyverse)
df_long_PL <- pivot_longer(df_wide,
                             cols = -c('id', 'sex'),
                             names_to = 'week',
                             values_to = 'weekly_val')
df_long_PL
```

`pivot_longer()` is particularly useful (a) when dealing with wide data that contain multiple different sets of repeated measures that need to be lengthened separately (e.g., two monthly height measurements and two monthly weight measurements in each row) and/or (b) when column names and/or column values in the long data need to be extracted from column names of the *wide* data using regular expressions. For example, say we begin with a wide data frame, `animals_wide`, that looks like this:
  
```{r, echo = F}
library(tidyverse)
animals_wide <- data.frame(animal = c('dolphin', 'porcupine', 'rabbit'),
                           loves_water = c(T, F, F),
                           ABC_1 = c(1, 4, 2),
                           ABC_2 = c(5, 5, 2),
                           XYZ_1 = c(6, 3, 5),
                           XYZ_2 = c(2, 1, 2))
animals_wide
```

`pivot_longer()` could be used to convert this data frame to a long format in a couple of different ways:

```{r}
# Long data will contain one column for each measure (ABC and XYZ)
animals_long_1 <- pivot_longer(animals_wide,
                             cols = -c('animal', 'loves_water'),
                             # ".value" serves as placeholder for values that will be extracted from wide column names
                             names_to = c('.value', 'measure_num'), 
                             names_pattern = '(.+)_(.)')
animals_long_1
# Long data will contain one column containing values for both measures together (ABC and XYZ)
animals_long_2 <- pivot_longer(animals_wide,
                               cols = -c('animal', 'loves_water'),
                               names_to = c('measure', 'measure_num'),
                               names_pattern = '(.+)_(.)',
                               values_to = 'measure_val')
animals_long_2
```

## Reshape long to wide

To take data from long to wide using the `reshape()` function, the user specifies `direction = 'wide'`. The user also provides `idvar`, `v.names`, and `timevar` arguments, which serve the same purpose as they do when `reshape()` is used to lengthen data: `idvar` specifies the variable(s) that uniquely "group" values together that will be displayed in the same row in the wide data; `v.names` indicates the variable that contains the values that are to be widened; and `timevar` refers to the column in the long data that identifies each value's context (its time point, its measurement location, etc.). The contents of the `timevar` column are used to generate the widened column names, as demonstrated below.

```{r}
df_long
df_wide <- reshape(df_long,
                   direction = 'wide',
                   idvar = c('id', 'sex'),
                   v.names = 'weekly_val',
                   timevar = 'week',
                   sep = '...') # the `sep` argument allows a user to specify how the contents of `timevar` should be joined with the `v.names` variable to form wide column names
df_wide
```

The **tidyverse** function for taking data from long to wide is `pivot_wider()`. To recreate the output of the `reshape()` function above using `pivot_longer()`, a user would write:

```{r}
library(tidyverse)
df_wide_PW <- pivot_wider(df_long,
                          id_cols = c('id', 'sex'),
                          values_from = 'weekly_val',
                          names_from = 'week')
df_wide_PW
```

`pivot_wider()` offers a lot of usability when trying to reshape more-complicated long data structures:

```{r}
# Convert long data with one column for each measure (ABC and XYZ) into wide format
animals_long_1
animals_wide <- pivot_wider(animals_long_1,
                            id_cols = c('animal', 'loves_water'),
                            values_from = c('ABC', 'XYZ'),
                            names_from = 'measure_num',
                            names_sep = '_')
animals_wide
# Convert long data with one column containing values for both measures together (ABC and XYZ) into wide format
animals_long_2
animals_wide <- pivot_wider(animals_long_2,
                            id_cols = c('animal', 'loves_water'),
                            values_from = 'measure_val',
                            names_from = c('measure', 'measure_num'),
                            names_sep = '_')
animals_wide
```

#### Python {-}
#### R {-}


## Merge/Join

### Left Join

#### Python {-}
#### R {-}

### Right Join

#### Python {-}
#### R {-}

### Inner Join

#### Python {-}
#### R {-}

### Outer Join

#### Python {-}
#### R {-}